{
  "hash": "85833714a0379eb5af649696f8cce209",
  "result": {
    "markdown": "---\ntitle: \"Compiling KasmVNC on NixOS\"\ndate: \"2023-5-2\"\ncategories: [linux, devops, nix, kasm]\nexecute:\n  freeze: auto\n---\n\nThis is a living document, for the time being. Rather than a complete blogpost, this is a tracker of my progress, as well as a quick reference I can come back to.\n\n# What is this?\n\nKasmweb is a software to create remote desktops, that exist within docker containers, and allow users to access them, all from a browser based GUI. \n\nKasmvnc is the VNC server part of kasm web, a custom fork of previous existing features, enhanced with more performance, and most importantly, a web native setup. Incompatible with existing VNC protocols, the only way to access Kasmvnc is through the http/https serive it offers, the web based VNC ui. \n\nKasmVNC is an amazing piece of software, but development for it is not truly, fully public. This is present in their build system. Their build system is a series of bash scripts, that call docker containers, which call more bash scripts, to finally compile the software, and package it, all in one. \n\nAs part of the scripts they have to compile kasm, lots of static linking happens. They do this because not all distros package the most updated, performant versions of the libraries that kasmvnc uses. \n\nBut Nixos, the distro I want to package KasmVNC for, does. In addition to that, it is completely incompatible with the hacked together build system that kasm uses. In order to package KasmVNC for Nixos, I must reverse engineer their build system, and bit by bit, port it to NixOS. \n\n# Nixos Build System\n\nHow the nixos build system works. I will do later, but here I will document, step by step, how nixos builds a package.\n\n# KasmVNC's Build System\n\nReverse engineering KasmVNC's build system. \n\n\nThe below is what I neeed for the compiliation commands to work. I don't know where Kasm runs these commands, or similar equivalents, this is just what I've figured out. \n\nPerhaps I need to only run `make` in the KasmVNC/unix directory?\n\n\n```{bash}\n\ngit clone https://github.com/TigerVNC/tigervnc\n\ncd tigervnc\n\ngit clone https://github.com/kasmtech/KasmVNC\n\ncd KasmVNC\n\ncp ..vncserver .vncserver # this sets up build environment. I will still need to check if every single one of these things are necessary, but this works for now\n```\n\n\nThe build script can be found [here](https://github.com/kasmtech/KasmVNC/blob/4d3a9b749adfcf89bde0b970c1c37481c92d585b/builder/build.sh#L63)\n\nBut from this build script, I don't think all of it is necessary. Below, I will extract what commands are actually needed, from all the fluff, cruft, and hacks. \n\n\n```{bash}\n\ncmake -D CMAKE_BUILD_TYPE=RelWithDebInfo . -DBUILD_VIEWER:BOOL=OFF \\\n  -DENABLE_GNUTLS:BOOL=OFF\n\nmake\n```\n\n\nBuilds end up in `KasmVNC/unix/`\n\nExcept the preliminary builds don't work. They error:\n\n\n```{bash}\n\n~/vscode/tigervnc/KasmVNC/unix master ?1 ❯ ./vncserver \n\nCan't locate List/MoreUtils.pm in @INC (you may need to install the List::MoreUtils module) (@INC contains: /usr/lib/perl5/5.36/site_perl /usr/share/perl5/site_perl /usr/lib/perl5/5.36/vendor_perl /usr/share/perl5/vendor_perl /usr/lib/perl5/5.36/core_perl /usr/share/perl5/core_perl) at ./vncserver line 38.\nBEGIN failed--compilation aborted at ./vncserver line 38.\n\n```\n\n\nThe above is probably because a perl library is missing. After attempting to install the missing library using `pacman -S perl-list-moreutils` I get a different error.\n\n\n```{bash}\n\n~/vscode/tigervnc/KasmVNC/unix master ?1 ❯ ./vncserver \n\nCan't locate KasmVNC/CliOption.pm in @INC (you may need to install the KasmVNC::CliOption module) (@INC contains: /usr/lib/perl5/5.36/site_perl /usr/share/perl5/site_perl /usr/lib/perl5/5.36/vendor_perl /usr/share/perl5/vendor_perl /usr/lib/perl5/5.36/core_perl /usr/share/perl5/core_perl) at ./vncserver line 42.\nBEGIN failed--compilation aborted at ./vncserver line 42.\n\n```\n\n\nObviously, this won't work. I must figure out why KasmVNC pacakges perl packages, where it puts them by default, and how to package them for Nix. \n\n",
    "supporting": [
      "index_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}